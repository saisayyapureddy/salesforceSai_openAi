<template>
    <lightning-card title="Dynamic SOQL Query Builder" icon-name="utility:search">
        <div class="slds-m-around_medium">
            <!-- Object Selection -->
            <div class="slds-form-element slds-m-bottom_medium">
                <label class="slds-form-element__label" for="objectSelect">
                    <abbr class="slds-required" title="required">*</abbr>
                    Select Salesforce Object
                </label>
                <div class="slds-form-element__control">
                    <div class="slds-select_container">
                        <select class="slds-select" id="objectSelect" onchange={handleObjectChange}>
                            <option value="">Choose an object...</option>
                            <template for:each={objectOptions} for:item="option">
                                <option key={option.value} value={option.value}>{option.label}</option>
                            </template>
                        </select>
                    </div>
                </div>
                <template if:true={selectedObjectDescription}>
                    <div class="slds-form-element__help">{selectedObjectDescription}</div>
                </template>
            </div>

            <!-- Field Selection -->
            <template if:true={showFieldSelection}>
                <div class="slds-form-element slds-m-bottom_medium">
                    <fieldset class="slds-form-element">
                        <legend class="slds-form-element__legend slds-form-element__label">
                            Select Fields
                        </legend>
                        <div class="slds-form-element__control">
                            <div class="slds-button-group slds-m-bottom_small" role="group">
                                <button class="slds-button slds-button_neutral" onclick={selectAllFields}>
                                    Select All
                                </button>
                                <button class="slds-button slds-button_neutral" onclick={clearAllFields}>
                                    Clear All
                                </button>
                            </div>
                            <div class="slds-scrollable" style="height: 200px; border: 1px solid #d8dde6;">
                                <template for:each={fieldOptions} for:item="field">
                                    <div key={field.value} class="slds-checkbox slds-p-horizontal_small">
                                        <input type="checkbox" id={field.value} data-field={field.value}
                                            onchange={handleFieldSelection} />
                                        <label class="slds-checkbox__label" for={field.value}>
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-form-element__label">
                                                {field.label}
                                                <template if:true={field.isIndexed}>
                                                    <lightning-icon icon-name="utility:success" size="xx-small"
                                                        title="Indexed Field"></lightning-icon>
                                                </template>
                                            </span>
                                        </label>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </template>

            <!-- WHERE Conditions -->
            <template if:true={showConditions}>
                <div class="slds-form-element slds-m-bottom_medium">
                    <fieldset class="slds-form-element">
                        <legend class="slds-form-element__legend slds-form-element__label">
                            WHERE Conditions
                        </legend>
                        <div class="slds-form-element__control">
                            <template for:each={whereConditions} for:item="condition" for:index="index">
                                <div key={condition.id} class="slds-grid slds-gutters slds-m-bottom_small">
                                    <!-- Logic Operator -->
                                    <template if:false={condition.isFirst}>
                                        <div class="slds-col slds-size_1-of-12">
                                            <div class="slds-select_container">
                                                <select class="slds-select" data-index={index}
                                                    onchange={handleLogicOperatorChange}>
                                                    <option value="AND">AND</option>
                                                    <option value="OR">OR</option>
                                                </select>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Field -->
                                    <div class="slds-col slds-size_3-of-12">
                                        <div class="slds-select_container">
                                            <select class="slds-select" data-index={index} data-field="field"
                                                onchange={handleConditionChange}>
                                                <option value="">Select Field...</option>
                                                <template for:each={fieldOptions} for:item="field">
                                                    <option key={field.value} value={field.value}>{field.label}</option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Operator -->
                                    <div class="slds-col slds-size_2-of-12">
                                        <div class="slds-select_container">
                                            <select class="slds-select" data-index={index} data-field="operator"
                                                onchange={handleConditionChange}>
                                                <template for:each={operatorOptions} for:item="op">
                                                    <option key={op.value} value={op.value}>{op.label}</option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Value -->
                                    <div class="slds-col slds-size_3-of-12">
                                        <lightning-input type="text" data-index={index} data-field="value"
                                            onchange={handleConditionChange} placeholder="Enter value...">
                                        </lightning-input>
                                    </div>

                                    <!-- Remove Button -->
                                    <div class="slds-col slds-size_1-of-12">
                                        <lightning-button-icon icon-name="utility:delete" variant="border-filled"
                                            data-index={index} onclick={removeCondition}>
                                        </lightning-button-icon>
                                    </div>
                                </div>
                            </template>
                            <lightning-button variant="brand" label="Add Condition" onclick={addCondition}>
                            </lightning-button>
                        </div>
                    </fieldset>
                </div>
            </template>

            <!-- ORDER BY, LIMIT, OFFSET -->
            <template if:true={showAdditionalOptions}>
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <!-- ORDER BY -->
                    <div class="slds-col slds-size_4-of-12">
                        <lightning-combobox name="orderBy" label="ORDER BY" placeholder="Select field..."
                            options={fieldOptions} value={orderByField} onchange={handleOrderByChange}>
                        </lightning-combobox>
                    </div>

                    <!-- Sort Direction -->
                    <div class="slds-col slds-size_2-of-12">
                        <lightning-combobox name="sortDirection" label="Direction" options={sortOptions}
                            value={sortDirection} onchange={handleSortDirectionChange}>
                        </lightning-combobox>
                    </div>

                    <!-- LIMIT -->
                    <div class="slds-col slds-size_3-of-12">
                        <lightning-input type="number" label="LIMIT" value={limitValue} onchange={handleLimitChange}
                            max="50000">
                        </lightning-input>
                    </div>

                    <!-- OFFSET -->
                    <div class="slds-col slds-size_3-of-12">
                        <lightning-input type="number" label="OFFSET" value={offsetValue} onchange={handleOffsetChange}>
                        </lightning-input>
                    </div>
                </div>
            </template>

            <!-- Generated Query -->
            <div class="slds-form-element slds-m-bottom_medium">
                <label class="slds-form-element__label">Generated SOQL Query</label>
                <div class="slds-form-element__control">
                    <div class="slds-textarea"
                        style="background-color: #f3f3f3; font-family: monospace; min-height: 100px; padding: 10px;">
                        {generatedQuery}
                    </div>
                    <div class="slds-m-top_small">
                        <lightning-button variant="brand" label="Copy Query" onclick={copyQuery}>
                        </lightning-button>
                        <lightning-button variant="success" label="Execute Query" onclick={executeQuery}
                            class="slds-m-left_small">
                        </lightning-button>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <template if:true={showInsights}>
                <lightning-card title="AI Performance Insights" icon-name="utility:einstein">
                    <div class="slds-p-around_medium">
                        <!-- Performance Score -->
                        <div class="slds-m-bottom_medium">
                            <div class="slds-grid slds-grid_align-spread">
                                <div class="slds-col">
                                    <span class="slds-text-heading_small">Performance Score:</span>
                                </div>
                                <div class="slds-col">
                                    <lightning-badge label={performanceScore} variant={performanceScoreVariant}>
                                    </lightning-badge>
                                </div>
                            </div>
                        </div>

                        <!-- Optimization Tips -->
                        <template if:true={optimizationTips.length}>
                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-heading_small slds-m-bottom_small">Optimization Tips:</h4>
                                <template for:each={optimizationTips} for:item="tip">
                                    <div key={tip} class="slds-m-bottom_x-small">
                                        <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                                        <span class="slds-m-left_x-small">{tip}</span>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Query Explanation -->
                        <template if:true={queryExplanation}>
                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-heading_small slds-m-bottom_small">Query Explanation:</h4>
                                <p>{queryExplanation}</p>
                            </div>
                        </template>

                        <!-- Best Practice Tip -->
                        <template if:true={bestPracticeTip}>
                            <div class="slds-box slds-theme_info">
                                <lightning-icon icon-name="utility:knowledge_base" size="small"></lightning-icon>
                                <span class="slds-m-left_small"><strong>Tip:</strong> {bestPracticeTip}</span>
                            </div>
                        </template>
                    </div>
                </lightning-card>
            </template>

            <!-- Query Results -->
            <template if:true={queryResults}>
                <lightning-card title="Query Results" icon-name="utility:table">
                    <div class="slds-p-around_medium">
                        <p class="slds-m-bottom_small">Found {recordCount} record(s)</p>
                        <template if:true={queryResults.length}>
                            <div style="height: 300px;">
                                <lightning-datatable key-field="Id" data={queryResults} columns={tableColumns}
                                    hide-checkbox-column="true">
                                </lightning-datatable>
                            </div>
                        </template>
                    </div>
                </lightning-card>
            </template>
        </div>
    </lightning-card>
</template>
<template>
    <div class="soql-builder-container">
        <!-- Fixed Header -->
        <div class="header-section">
            <div class="header-content">
                <div class="header-left">
                    <lightning-icon icon-name="utility:search" size="medium" class="header-icon"></lightning-icon>
                    <div class="header-text">
                        <h1 class="main-title">Dynamic SOQL Query Builder</h1>
                        <p class="subtitle">AI-Powered Salesforce Query Assistant</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="loading-overlay">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- Main Content - Two Panel Layout -->
        <div class="main-content">

            <!-- Left Panel - Query Builder -->
            <div class="left-panel">

                <!-- Object Selection -->
                <div class="builder-section">
                    <div class="section-header">
                        <lightning-icon icon-name="standard:custom_object" size="small"></lightning-icon>
                        <h3 class="section-title">Select Salesforce Object</h3>
                    </div>
                    <div class="section-content">
                        <div class="slds-form-element">
                            <label class="slds-form-element__label" for="objectSelect">
                                <abbr class="slds-required" title="required">*</abbr>
                                Choose Salesforce Object
                            </label>
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select custom-select" id="objectSelect"
                                        onchange={handleObjectChange} value={selectedObject}>
                                        <option value="">üîç Search and select an object...</option>
                                        <template for:each={objectOptions} for:item="option">
                                            <option key={option.value} value={option.value}>
                                                {option.label} <template if:true={option.isCustom}>(Custom)</template>
                                            </option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <template if:true={selectedObjectDescription}>
                                <div class="object-description">
                                    <lightning-icon icon-name="utility:info" size="xx-small"></lightning-icon>
                                    <span>{selectedObjectDescription}</span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Field Selection -->
                <template if:true={showFieldSelection}>
                    <div class="builder-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:multiselect_checkbox" size="small"></lightning-icon>
                            <h3 class="section-title">Select Fields</h3>
                            <div class="field-buttons">
                                <button class="custom-button secondary" onclick={selectAllFields}>Select All</button>
                                <button class="custom-button secondary" onclick={clearAllFields}>Clear All</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="field-grid">
                                <template for:each={fieldSelectionOptions} for:item="field">
                                    <div key={field.value} class="field-item">
                                        <div class="slds-checkbox">
                                            <input type="checkbox" id={field.fieldId} data-field={field.value}
                                                onchange={handleFieldSelection} class="slds-checkbox__input" />
                                            <label class="slds-checkbox__label" for={field.fieldId}>
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="field-info">
                                                    <span class="field-name">{field.label}</span>
                                                    <template if:true={field.isDate}>
                                                        <span class="field-type-badge date-badge">üìÖ DATE</span>
                                                    </template>
                                                    <template if:true={field.isPicklist}>
                                                        <span class="field-type-badge picklist-badge">üìã PICKLIST</span>
                                                    </template>
                                                    <template if:true={field.isNumber}>
                                                        <span class="field-type-badge number-badge">#Ô∏è‚É£ NUMBER</span>
                                                    </template>
                                                    <template if:true={field.isIndexed}>
                                                        <lightning-icon icon-name="utility:success" size="xx-small"
                                                            title="Indexed Field"
                                                            class="indexed-badge"></lightning-icon>
                                                    </template>
                                                    <template if:true={field.isRequired}>
                                                        <lightning-icon icon-name="utility:priority" size="xx-small"
                                                            title="Required Field"
                                                            class="required-badge"></lightning-icon>
                                                    </template>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- WHERE Conditions -->
                <template if:true={showConditions}>
                    <div class="builder-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:filter" size="small"></lightning-icon>
                            <h3 class="section-title">WHERE Conditions</h3>
                        </div>
                        <div class="section-content">
                            <template for:each={whereConditions} for:item="condition" for:index="index">
                                <div key={condition.id} class="condition-row">
                                    <!-- Logic Operator (AND/OR) -->
                                    <template if:false={condition.isFirst}>
                                        <div class="condition-logic">
                                            <select class="slds-select mini-select" data-index={index}
                                                onchange={handleLogicOperatorChange} value={condition.logicOperator}>
                                                <option value="AND">AND</option>
                                                <option value="OR">OR</option>
                                            </select>
                                        </div>
                                    </template>

                                    <!-- Field Selection -->
                                    <div class="condition-field">
                                        <select class="slds-select" data-index={index} data-field="field"
                                            onchange={handleConditionChange} value={condition.field}>
                                            <option value="">Select Field...</option>
                                            <template for:each={fieldOptions} for:item="field">
                                                <option key={field.value} value={field.value}>
                                                    {field.label}
                                                    <template if:true={field.isDate}> (Date)</template>
                                                    <template if:true={field.isPicklist}> (Picklist)</template>
                                                    <template if:true={field.isNumber}> (Number)</template>
                                                </option>
                                            </template>
                                        </select>
                                    </div>

                                    <!-- Operator Selection -->
                                    <div class="condition-operator">
                                        <select class="slds-select" data-index={index} data-field="operator"
                                            onchange={handleConditionChange} value={condition.operator}>
                                            <template for:each={operatorOptions} for:item="op">
                                                <option key={op.value} value={op.value}>{op.label}</option>
                                            </template>
                                        </select>
                                    </div>

                                    <!-- Dynamic Value Input -->
                                    <div class="condition-value">
                                        <!-- Date Field Input -->
                                        <template if:true={condition.isDateField}>
                                            <lightning-input type={condition.dateInputType} data-index={index}
                                                data-field="value" onchange={handleConditionChange}
                                                value={condition.value} variant="label-hidden" class="date-input">
                                            </lightning-input>
                                        </template>

                                        <!-- Picklist Field Input -->
                                        <template if:true={condition.isPicklistField}>
                                            <lightning-combobox data-index={index} data-field="value"
                                                onchange={handleConditionChange} options={condition.picklistOptions}
                                                value={condition.value} placeholder="Select value..."
                                                variant="label-hidden" class="picklist-input">
                                            </lightning-combobox>
                                        </template>

                                        <!-- Number Field Input -->
                                        <template if:true={condition.isNumberField}>
                                            <lightning-input type="number" data-index={index} data-field="value"
                                                onchange={handleConditionChange} value={condition.value}
                                                variant="label-hidden" class="number-input">
                                            </lightning-input>
                                        </template>

                                        <!-- Boolean Field Input -->
                                        <template if:true={condition.isBooleanField}>
                                            <lightning-combobox data-index={index} data-field="value"
                                                onchange={handleConditionChange} options={condition.booleanOptions}
                                                value={condition.value} placeholder="Select..." variant="label-hidden"
                                                class="boolean-input">
                                            </lightning-combobox>
                                        </template>

                                        <!-- Text Field Input (Default) -->
                                        <template if:false={condition.isDateField}>
                                            <template if:false={condition.isPicklistField}>
                                                <template if:false={condition.isNumberField}>
                                                    <template if:false={condition.isBooleanField}>
                                                        <lightning-input type="text" data-index={index}
                                                            data-field="value" onchange={handleConditionChange}
                                                            value={condition.value} placeholder="Enter value..."
                                                            variant="label-hidden" class="text-input">
                                                        </lightning-input>
                                                    </template>
                                                </template>
                                            </template>
                                        </template>
                                    </div>

                                    <!-- Remove Button -->
                                    <div class="condition-remove">
                                        <lightning-button-icon icon-name="utility:delete" variant="border-filled"
                                            data-index={index} onclick={removeCondition} size="small">
                                        </lightning-button-icon>
                                    </div>
                                </div>
                            </template>

                            <button class="custom-button primary" onclick={addCondition}>
                                + Add Condition
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Additional Options -->
                <template if:true={showAdditionalOptions}>
                    <div class="builder-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:settings" size="small"></lightning-icon>
                            <h3 class="section-title">Additional Options</h3>
                        </div>
                        <div class="section-content">
                            <div class="options-grid">
                                <div class="option-item">
                                    <label class="option-label">ORDER BY</label>
                                    <lightning-combobox name="orderBy" placeholder="Select field..."
                                        options={fieldOptions} value={orderByField} onchange={handleOrderByChange}
                                        variant="label-hidden">
                                    </lightning-combobox>
                                </div>

                                <div class="option-item">
                                    <label class="option-label">Direction</label>
                                    <lightning-combobox name="sortDirection" options={sortOptions} value={sortDirection}
                                        onchange={handleSortDirectionChange} variant="label-hidden">
                                    </lightning-combobox>
                                </div>

                                <div class="option-item">
                                    <label class="option-label">LIMIT</label>
                                    <lightning-input type="number" value={limitValue} onchange={handleLimitChange}
                                        max="50000" min="1" variant="label-hidden" class="limit-input">
                                    </lightning-input>
                                </div>

                                <div class="option-item">
                                    <label class="option-label">OFFSET</label>
                                    <lightning-input type="number" value={offsetValue} onchange={handleOffsetChange}
                                        min="0" variant="label-hidden" class="offset-input">
                                    </lightning-input>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Right Panel - Query & Insights -->
            <div class="right-panel">

                <!-- Generated Query -->
                <div class="query-section">
                    <div class="section-header">
                        <lightning-icon icon-name="utility:code" size="small"></lightning-icon>
                        <h3 class="section-title">Generated SOQL Query</h3>
                        <button class="custom-button secondary" onclick={copyQuery}>
                            üìã Copy
                        </button>
                    </div>
                    <div class="query-content">
                        <div class="query-editor">
                            <pre class="query-text">{generatedQuery}</pre>
                        </div>
                        <div class="query-actions">
                            <button class="custom-button primary execute-btn" onclick={executeQuery}
                                disabled={isLoading}>
                                ‚ö° Execute Query
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Optimization -->
                <template if:true={showInsights}>
                    <div class="insights-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:einstein" size="small" class="ai-icon"></lightning-icon>
                            <h3 class="section-title">AI Optimization</h3>
                            <div class="performance-badge {performanceScoreVariant}">{performanceGrade}</div>
                        </div>
                        <div class="insights-content">
                            <template if:true={hasOptimizationTips}>
                                <template for:each={optimizationTips} for:item="tip">
                                    <div key={tip} class="tip-item">
                                        <lightning-icon icon-name="utility:warning" size="xx-small"
                                            class="tip-icon"></lightning-icon>
                                        <span class="tip-text">{tip}</span>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Query Explanation -->
                <template if:true={queryExplanation}>
                    <div class="explanation-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:info" size="small"></lightning-icon>
                            <h3 class="section-title">Query Explanation</h3>
                        </div>
                        <div class="explanation-content">
                            <p class="explanation-text">{queryExplanation}</p>
                        </div>
                    </div>
                </template>

                <!-- Best Practice Tip -->
                <template if:true={bestPracticeTip}>
                    <div class="tip-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:knowledge_base" size="small"></lightning-icon>
                            <h3 class="section-title">Best Practice Tip</h3>
                        </div>
                        <div class="tip-content">
                            <p class="tip-text">{bestPracticeTip}</p>
                        </div>
                    </div>
                </template>

                <!-- Query Results -->
                <template if:true={showResults}>
                    <div class="results-section">
                        <div class="section-header">
                            <lightning-icon icon-name="utility:table" size="small"></lightning-icon>
                            <h3 class="section-title">Query Results</h3>
                            <div class="results-count">{recordCount} records</div>
                        </div>
                        <div class="results-content">
                            <template if:true={hasQueryResults}>
                                <div class="dark-datatable">
                                    <lightning-datatable key-field="Id" data={queryResults} columns={tableColumns}
                                        hide-checkbox-column="true" max-row-selection="0">
                                    </lightning-datatable>
                                </div>
                            </template>
                            <template if:false={hasQueryResults}>
                                <div class="no-results">
                                    <span>No records found matching your criteria.</span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</template>